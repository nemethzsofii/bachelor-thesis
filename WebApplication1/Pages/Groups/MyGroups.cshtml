@page
@model WebApplication1.Pages.Groups.MyGroupsModel
@{
}

<div id="groups-container">
	<ul class="nav nav-tabs" id="groups-tab" role="tablist">
		
	</ul>
	<div class="tab-content" id="groups-tab-content">

	</div>
</div>
<script>
	document.addEventListener("DOMContentLoaded", function () {
		var user = getCurrentUser();
		console.log("1");
		getGroupsForCurrentUser();
		console.log("2");
		console.log("3");

		
		async function getGroupsForCurrentUser() {
			const response = await fetch("/api/GroupMembership/ByUser", {
				method: "GET",
				 headers: {
					"Content-Type": "application/json",
					"Accept": "application/json"
				},
				credentials: "include"
			});

			if (!response.ok) {
				const errorMessage = await response.json();
				displayBasicModal("Something went wrong!", "Error");
				console.error(`Error: ${response.status} - ${errorMessage}`);
			} else {
				const result = await response.json()
				displayGroups(result);
			}
		}

		async function displayGroups(result){
			var containerDiv = document.getElementById("groups-container");
			var groupsTab = document.getElementById("groups-tab");
			var groupsContent = document.getElementById("groups-tab-content");

			console.log(result);
			if (result.lentgh == 0){
				containerDiv.innerHTML = "No groups:(";
			}else{
				for(let i=0; i < result.length; i++){
					var group = await getGroupById(result[i].groupId);
					groupsTab.innerHTML += `
					<li class="nav-item">
					<a class="nav-link ${i == 0 ? 'active' : ''}" id="${i}-tab" data-toggle="tab" href="#content${i}" role="tab" aria-controls="content${i}" aria-selected="true">${group.name}</a>
					</li>
					`

					groupsContent.innerHTML +=
					`
					<div class="tab-pane fade show ${i == 0 ? 'active' : ''}" id="content${i}" role="tabpanel" aria-labelledby="${i}-tab">${group.description}</div>
					`
				}
			}
		}

		async function getGroupById(id) {
			const response = await fetch(`/api/Group/${id}`, {
				method: "GET",
				 headers: {
					"Content-Type": "application/json",
					"Accept": "application/json"
				},
				credentials: "include"
			});

			if (!response.ok) {
				const errorMessage = await response.json();
				displayBasicModal("Something went wrong!", "Error");
				console.error(`Error: ${response.status} - ${errorMessage}`);
				return null;
			} else {
				const result = await response.json()
				return result;
			}
		}
	});
</script>